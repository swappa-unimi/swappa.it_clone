<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
 <title>Swappa : Uni / Basi di Dati - Complementi - Lezione del 3 marzo 2008</title>
 <meta http-equiv='Content-Type' content='text/html; charset=ISO-8859-1' />
 <meta http-equiv='Content-Language' content='en' />
 <meta http-equiv='Content-Style-Type' content='text/css' />
 <meta http-equiv="imagetoolbar" content="no" />
 <meta name='MSSmartTagsPreventParsing' content='true' />
 <!--HeaderText--><style type='text/css'><!--
  ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }
  code.escaped { white-space: nowrap; }
  .vspace { margin-top:1.33em; }
  .indent { margin-left:40px; }
  .outdent { margin-left:40px; text-indent:-40px; }
  a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
  a.createlink { text-decoration:none; position:relative; top:-0.5em;
    font-weight:bold; font-size:smaller; border-bottom:none; }
  img { border:0px; }
  
.progress-bar {
	display: block;
	background: transparent; 
	width: 520px;
	font-size: 1px; /* for IE */
	margin: 2px 0;
}

.progress-bar .pb1, .progress-bar .pb2, .progress-bar .pb3, .progress-bar .pb4 {
	display: block; 
	background: #fff; 
	border-left:  1px solid #999; 
	border-right: 1px solid #999;

	overflow: hidden; 
	height: 1px; 
}
.progress-bar .pb1 { margin: 0 4px; background: #999;}
.progress-bar .pb2 { margin: 0 2px; border-width: 0 2px; }
.progress-bar .pb3 { margin: 0 1px; }
.progress-bar .pb4 { height: 11px; padding: 0 3px; }
.progress-bar .pb5 { display: block; background: #eeeeef; overflow:hidden; }

.progress-bar .bar {
	display: block;
	background: #a5bbd8;
	height: 11px;
	padding: 0;
}
.editconflict { color:green; 
  font-style:italic; margin-top:1.33em; margin-bottom:1.33em; }

  table.markup { border:2px dotted #ccf; width:90%; }
  td.markup1, td.markup2 { padding-left:10px; padding-right:10px; }
  table.vert td.markup1 { border-bottom:1px solid #ccf; }
  table.horiz td.markup1 { width:23em; border-right:1px solid #ccf; }
  table.markup caption { text-align:left; }
  div.faq p, div.faq pre { margin-left:2em; }
  div.faq p.question { margin:1em 0 0.75em 0; font-weight:bold; }
  div.faqtoc div.faq * { display:none; }
  div.faqtoc div.faq p.question 
    { display:block; font-weight:normal; margin:0.5em 0 0.5em 20px; line-height:normal; }
  div.faqtoc div.faq p.question * { display:inline; }
   
    .frame 
      { border:1px solid #cccccc; padding:4px; background-color:#f9f9f9; }
    .lfloat { float:left; margin-right:0.5em; }
    .rfloat { float:right; margin-left:0.5em; }
a.varlink { text-decoration:none; }

--></style>
  <link rel='stylesheet' href='../pub/wsplus/wsplus.css' 
    type='text/css' />
  <!--[if IE]><style type='text/css' media='screen'>
    body { behavior:url('http://www.swappa.it/wiki/pub/wsplus/csshover.htc'); }
    .rollover * { visibility: visible; }
  </style><![endif]-->
<script type='text/javascript' src='../pub/syntaxlove/scripts/shCore.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushCSharp.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushCpp.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushJava.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushPerl.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushPhp.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushPython.js'></script><script type='text/javascript' src='../pub/syntaxlove/scripts/shBrushRuby.js'></script> <link type='text/css' rel='stylesheet' href='../pub/syntaxlove/css/shCore.css'/>
  <link type='text/css' rel='stylesheet' href='../pub/syntaxlove/css/shThemeDefault.css'/>
  <script type='text/javascript'>
  	SyntaxHighlighter.config.clipboardSwf = 'http://www.swappa.it/wiki/pub/syntaxlove/scripts/clipboard.swf';
  	SyntaxHighlighter.all();
  </script>  <meta name='robots' content='noindex,nofollow' />

 <style type='text/css'><!--

/* Default Fonts */
body { font-family: Verdana,Arial,Helvetica,sans-serif; }
body, td, th { color:#000000; }
body, td, th { font-size: 10pt; }
small { font-size:0.85em; }
code { white-space: nowrap; }
h1, h2, h3, h4, h5 { margin-top:1em; margin-bottom:0.6em; }
h1 { font-size: 1.9em; }
h2 { font-size: 1.5em; }
h3 { font-size: 1.25em; }
h4 { font-size: 1.06em; }
h5 { font-size: 1.0em; }
ul, ol, pre, dl, p { margin-top:0px; margin-bottom:0px; }

/* Misc. */
body { width:auto; background-color:#ffffff; margin:0px; padding:0.5em; }
img { border-width: 0px; }
.indent { margin-left:30px; }
.outdent { margin-left:30px; text-indent:-30px; }
.vspace { margin-top:1.33em; }

/* Links */
a:link { color:#333333; font-weight:normal; text-decoration:underline; }
a:visited { color:#333333; font-weight:normal; text-decoration:underline; }
a.wikilink:hover { color: #333333; text-decoration:underline; }
a.createlink { text-decoration:none; position:relative; top:-0.5em; font-weight:bold; font-size:smaller; border-bottom:none; }
a.createlinktext { text-decoration:none; border-bottom:1px dotted gray; }
a.varlink { text-decoration:none; }
.apprlink { font-size:smaller; }

/* Print View Page Header */
#printhead { font-size:11pt; border-bottom:2px solid #a0a0a0; margin-bottom:1em; }
#printhead a, #printhead a:visited { font-weight:bold; text-decoration:none; }
#cc { float:right; font-size:11pt; border-bottom:2px solid #a0a0a0; margin-bottom:1em; }

/* Print View Page Footer */
#printfoot { font-family: Arial,Helvetica,Geneva,sans-serif; margin-top:1em; border-top:2px solid #a0a0a0; font-size:7pt; }
  
 --></style>
</head>
<body>
  <div id='printhead'>
    <a href='../index.html' title='Swappa Home'>Swappa</a> :
    <a href='http://www.swappa.it/wiki/Uni' title='Uni Home'>Uni</a> /
    <a href='BDC3marzo2008.html' title='Basi di Dati - Complementi - Lezione del 3 marzo 2008'>Basi di Dati - Complementi - Lezione del 3 marzo 2008</a>
    <div id='cc'>
	<a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/2.5/it/">
	<img alt="Creative Commons License" style="border-width:0" height="15" width="80" src="http://i.creativecommons.org/l/by-nc-sa/2.5/it/80x15.png" />
	</a>
    </div>
  </div>
  
<!--PageText-->
<div id='wikitext'>
<p>
</p>
<div class='vspace'></div><pre  style='text-align: center; background-color: #ffe4c4; border: 2px solid #cccccc; font-size: 13pt; padding: 5px;'> <strong>:: Basi di Dati - Complementi - Lezione del 3 marzo 2008 ::</strong>
</pre><p class='vspace'  style='text-align: center;'><span  style='background-color: #d9e4f2; font-size: 11pt; padding: 4px; padding-left: 50px; padding-right: 50px;'><strong>Appunti Glamour</strong></span>
</p>
<p class='vspace'><a class='wikilink' href='BDComplementi.html'>Torna alla pagina di Basi di Dati - Complementi</a>
</p>
<p class='vspace'><span  style='background-color: #d9e4f2; font-size: 11pt; padding: 4px; padding-left: 50px; padding-right: 50px;'><strong>Gestione delle transazioni</strong></span>
</p>
<p class='vspace'>La <strong>transazione</strong> è un'unità elementare di lavoro che deve avere certe caratteristiche:
</p><ul><li><strong>correttezza</strong>
</li><li><strong>robustezza</strong>
</li><li><strong>isolamento</strong>
</li></ul><p class='vspace'>Un <strong>sistema transazionale</strong> è il meccanismo che definisce ed esegue transazioni da parte di più applicazioni concorrenti. Garantisce il corretto comportamento del sistema, secondo le proprietà qui sopra citate.
</p>
<p class='vspace'>La sintassi <em>(in SQL???)</em> è la seguente:
</p>
<div class='vspace'></div><pre> begin transaction
 ...
 [lista operazioni]
 ...
 [commit | abort]
 end transaction
</pre><p class='vspace'>Le operazioni sono scritture, letture etc. etc., mentre la parte interessante è alla fine, il <strong>commit</strong> e l<strong>'abort</strong>.
Il commit lo si ha quando tutto va OK, e la transazione è completata con successo.
L'abort invece vuol dire che si è verificata qualche condizione di fallimento, e le operazioni vengono tutte annullate con un <strong>undo</strong>: si attua un <strong>rollback</strong>.
</p>
<p class='vspace'>In una <strong>transazione ben formata</strong>, alla fine ci può essere solo uno dei due: o commit, o abort. E dopo questo, non ci deve essere nessun'altra operazione.
</p>
<div class='vspace'></div><h2>Proprietà delle transazioni</h2>
<p>L'acronimo è <strong>ACID</strong>:
</p><ul><li>Atomicità
</li><li>consistenza
</li><li>Isolamento
</li><li>Durabilità = persistenza
</li></ul><div class='vspace'></div><div><span class='frame lfloat'><img src='../uploads/Uni/complementi1.jpg' alt='' title='' /><br /><strong>Immagine accattivante per studenti</strong></span></div>
<div class='vspace'></div><h3>Atomicità</h3>
<p>Una transazione è un'unità atomica, il che vuol dire che o l'eseguo tutta, o non eseguo niente. Non esistono stati intermedi. Un po' come i quanti della fisica. Se ci si ferma a metà, si disfa tutto e si fa l<strong>'UNDO</strong> di quanto già fatto. Se si ferma <em>DOPO</em> il commit, si fa il <strong>REDO</strong>.
</p>
<p class='vspace'>Di solito invece funziona egregiamente e si va al commit felicemente.
I casi di fallimento invece si possono distinguere in due tipi, amorevolmente così chiamati:
</p><ol><li>suicidio: è l'applicazione che decide il rollback
</li><li>omicidio: il rollback è deciso dal sistema
</li></ol><p class='vspace'>Tra aborti, suicidi ed omicidi, i Complementi di Basi di Dati sembrano più che altro Complementi di Genocidio di Massa. Potevano scegliere un linguaggio un po' meno cruento...
</p>
<p class='vspace'>Quando le cose non vanno a buon fine, non deve rimanere nessun effetto di ciò che è andato male: questa è l'atomicità.
</p>
<div class='vspace'></div><h3>Consistenza</h3>
<p>Una transazione non deve violare i vincoli di integrità.
</p>
<p class='vspace'>I vincoli li posso controllare durante la transazione, o alla fine della stessa. Le due cose NON sono equivalenti. Basti pensare infatti ad una transazione in cui i valori, durante l'esecuzione, sforano temporaneamente i vincoli di integrità, per poi ritornare nella norma alla fine della transazione.
</p>
<div class='vspace'></div><h3>Isolamento</h3>
<p>L'esecuzione di una transazione deve essere indipendente dalle altre transazioni eseguite contemporaneamente. Vuol dire che il risultato deve essere lo stesso sia nell'eseguire le trans in sequenza, che eseguirle in parallelo.
</p>
<div class='vspace'></div><h3>Durabilità = persistenza</h3>
<p>Gli effetti di una transazione non devono andare persi. Se una trans arriva al commit, è come quando il faraone ha parlato.
</p>
<div class='vspace'></div><h3>Chi garantisce ACID?</h3>
<p>Queste simpatiche proprietà sono garantite dai moduli del DBMS, cioè parti del sistema informativo che presiedono al rispetto di ACID.
</p>
<div class='vspace'></div><ul><li><strong>Gestore dell'affidabilità</strong>: si prende cura di A e P
</li><li><strong>Compilatore DDL</strong>: C
</li><li><strong>Gestore della concorrenza</strong>: I
</li></ul><p class='vspace'>Nota sul Compilatore DDL. DDL = Data Description Language, ovvero il linguaggio che uso per descrivere i dati. Quando descrivo i miei bei dati, il compilatore provvede ad inserire dei controlli sui miei vincoli di integrità.
</p>
<div class='vspace'></div><h3>Gestore Affidabilità</h3>
<p>Si occupa di A e C. Esegue i <em>comandi transazionali</em>: <strong>B</strong> (begin), <strong>C</strong> (commit) e <strong>A</strong> (abort).
</p>
<p class='vspace'>Se qualcosa non va, deve garantire (ancora questo verbo...) che il sistema venga ripristinato al suo stato corretto. E come faccio? Semplice, uso la <strong>MEMORIA STABILE</strong>!
</p>
<p class='vspace'>Non che esista, ed infatti è un'astrazione: si tratta di quella memoria il cui contenuto non viene mai perso. Per approssimarsi a questa astrazione, si ricorre a vari metodi, tra cui quello di duplicare i dati in posti diversi, in modi diversi etc. così da minimizzare la probabilità che tutto vada perduto. La memoria stabile è quindi resa <strong>resistente ai guasti</strong>. Un guasto alla memoria stabile viene detto <strong>catastrofico</strong>, nonché definito <strong>impossibile</strong>. 
</p>
<p class='vspace'>Il Gestore dell'Affidabilità mantiene un log con su scritto tutto quanto fa. Questo log risiede in memoria stabile per resistere alla jella più nera e alle plugin più osé. Si tratta di un file in cui si tiene traccia di tutto quello che viene fatto dal DBMS, in ordine cronologico. Siccome tiene traccia di tutto, rende possibile il REDO e l'UNDO (vedremo poi).
</p>
<p class='vspace'>Il log contiene 2 tipi di record: 
</p><ul><li>record di <strong>transazione</strong>, che contiene i comandi <strong>begin, insert, delete, update, commit, abort</strong>;
</li><li>record di <strong>sistema</strong>, che contiene i comandi <strong>dump</strong> e <strong>checkpoint</strong>. Il DUMP fa il backup completo del database, mentre il CHECKPOINT tiene traccia di tutte le transazioni in esecuzione in un dato istante di tempo.
</li></ul><p class='vspace'>Ma non registra solo il comando, bensì anche lo stato delle cose PRIMA (<strong>before state</strong>) e DOPO (<strong>after state</strong>) l'esecuzione del comando.
Questo vuol dire che registra le transazioni non in modo relativo, ma in modo assoluto. Per intenderci, non scrive 
</p><pre> x = 100
 x = x + 100
</pre><p>ma
</p><pre> x = 100
 x = 200
</pre><p>Salvandole in modo assoluto è possibile ripeterle o annullarle senza perdere informazioni.
</p>
<p class='vspace'>Quando si vuola fare l'UNDO di un'azione che agisce su un oggetto O, si guarda il log di quell'azione:
</p><ul><li>UNDO di un UPDATE: copio il BS dell'azione nell'oggetto modificato
</li><li>UNDO di un DELETE: ripristino O con il valore BS
</li><li>UNDO di un insert: cancello O
</li></ul><p class='vspace'>Per il REDO:
</p><ul><li>REDO di un UPDATE: copio AS in O
</li><li>REDO di un DELETE: cancello O
</li><li>REDO di un INSERT: reinserisco O
</li></ul><p class='vspace'>Sia UNDO che REDO godono della proprietà di <strong>idempotenza</strong>, ovvero fare UNDO(A) (dove A è un'azione) per 1 volta o per 1000 volte è la stessa cosa. Uguale discorso per REDO(A): farlo 1 o 100 volte è uguale, il risultato non cambierà mai. Questa proprietà è resa possibile dal fatto che salvo i valori assoluti delle operazioni, e non quelli relativi.
</p>
<div class='vspace'></div><h3>Checkpoint e Dump</h3>
<p>Il checkpoint si fa periodicamente, e consiste nel bloccare tutte le operazioni in corse e proibirne l'accettazione di nuove. Nel log scrivo il record di checkpoint, in cui annoto tutte le operazioni in corso in quell'istante, e poi riprendo.
</p>
<p class='vspace'>Il dump invece è una copia di tutta la base di dati, e quando la si fa, si ferma il tutto.
</p>
<div class='vspace'></div><h3>Regole di scrittura dei record dei log</h3>
<p>I record dei log vanno scritto rispettando 2 regole: <strong>write-ahead log</strong> e <strong>commit-precedenza</strong>.
</p>
<p class='vspace'><strong>Write-ahead log</strong> vuol dire che il BS va scritto PRIMA di effettuare le operazioni. Ciò permette l'UNDO in caso di rollback. Se scrivessi dopo, non avrebbe senso.
</p>
<p class='vspace'><strong>Commit-precedenza</strong> vuol dire invece che AS va scritto PRIMA di fare il commit, così è possibile fare il REDO.
</p>
<p class='vspace'>Viene registrato anche il commit, nel suo bel record di commit così, grazie a queste regole, se c'è un guasto appena prima di esso, faccio un REDO. Se c'è un guasto dopo, faccio un UNDO grazie ai miei AS e BS.
</p>
<p class='vspace'>Un altro problema che insorge è se attuare le operazioni sulla base di dati prima o dopo il commit.
Se prima opero e poi committo, non serve il REDO. Se prima committo e poi opero, non serve UNDO. Ma se lavoro un po' così e un po' cosà allora servono sia REDO che UNDO.
</p>
<div class='vspace'></div><h3>Guasti</h3>
<p>Sono di due tipi:
</p><ul><li>di sistema: è un bug del software, salta la corrente o cose del genere. I miei dispositivi di memorizzazione non vengono rovinati.
</li><li>di dispositivo: si sfasciano i dispositivi che ospitano i miei dati, e qui è più brutta.
</li></ul><p class='vspace'>Il log serve appunto per riparare i guasti di sistema, tramite un procedimento detto <strong>ripresa a caldo</strong>. Se invece ho un guasto di sistema, si attua la <strong>ripresa a freddo</strong>.
</p>
<p class='vspace'>Il modello che si segue come reazione ai guasti si chiama <strong>fail-stop</strong>: se c'è un guasto o un errore, fermo tutto, avvio le procedure di ripristino, e se queste vanno bene riparto con l'attività normale. Se invece le procedure di ripristino non vanno a buon fine, torno nella fase di stop, e ripeto finché le cose non funzionano.
</p>
<div class='vspace'></div><h3>Ripresa a caldo</h3>
<p>Ecco quello che succede in una ripresa a caldo.
</p><ol><li>Ripercorro il file di log all'indietro fino all'ultimo checkpoint effettuato
</li><li>Creo due insiemi: l'insieme REDO e l'insieme UNDO.
<ul><li>L'insieme REDO all'inizio è vuoto
</li><li>L'insieme UNDO viene riempito con tutte le transazioni che il checkpoint mi indica come attive
</li></ul></li><li>Percorro il log dal checkpoint in avanti, ed eseguo una di queste tre operazioni:
<ul><li>tutte le transazioni che iniziano ma non hanno un commit le metto nell'insieme UNDO
</li><li>sposto da UNDO a REDO tutte le transazioni di cui trovo il commit
</li><li>metto nell'insieme REDO tutte le transazioni iniziate dopo il checkpoint e che hanno il commit registrato prima del crash
</li></ul></li><li>Vado nel log al BOT (Begin Of Transaction) della transazione più vecchia che ho nei due insiemi REDO e UNDO
</li><li>Vado verso la fine del log ed eseguo tutte le operazioni delle transazioni che compaiono nei miei due insiemi.
</li></ol><div class='vspace'></div><h3>Ripresa a freddo</h3>
<ol><li>Vado all'ultimo DUMP e ripristino tutto il database copiandocelo sopra
</li><li>Vado indietro nel log fino al record dell'ultimo DUMP ed eseguo tutte le azioni indicate
</li><li>Eseguo una ripresa a caldo
</li></ol><p class='vspace'><a class='wikilink' href='BDComplementi.html'>Torna alla pagina di Basi di Dati - Complementi</a>
</p>
<div class='vspace'></div>
</div>

  <div id='printfoot'>
    <div class='printview'>(Printable View of <span style='white-space:nowrap;'>http://www.swappa.it/wiki/Uni/BDC3marzo2008)</span></div>
  </div>
</body>
</html>
